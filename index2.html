<!DOCTYPE html>
<html>
<head>
	<title></title>

	<script type="text/javascript">
		const mesa = {
			player1: {hp: 100, mt: 10, hit: 80, crt: 25, luck: 30, c:1},
			player2: {hp: 100, mt: 10, hit: 80, crt: 25, luck: 30, c:2},
			cpu: {hp: 100, mt: 10, hit: 80, crt: 25, luck: 30, c:"CPU"},

			gameStart: false,
			gameOver: false,
			turn:0,
			battleLock: false,

			drawSceneLogo: _=>{

				document.getElementById("logo").style.background = 'url("files/Fire_Emblem_logo.png")  center / 725px no-repeat';
				// document.getElementById("logo").style.backgroundSize = '400px';
				// document.getElementById("demo").style.backgroundRepeat = "no-repeat";
				document.getElementById("logo").style.height = "230px";

				document.getElementById("painel-buttons").innerHTML = "<button onclick='mesa.startgame()'>Iniciar o jogo</button>";	

			},

			startgame: _=>{
				mesa.gameStart = true;


				mesa.drawGame();
			},

			drawData: function(){
				let divPaineldata = document.getElementById("painel-data");
				divPaineldata.innerHTML = `PLAYER ${this.player1.c}: HP>${this.player1.hp},MT>${this.player1.mt}, HIT>${this.player1.hit}, CRT>${this.player1.crt}<p>`;
				divPaineldata.innerHTML += `PLAYER ${this.player2.c}: HP>${this.player2.hp},MT>${this.player2.mt}, HIT>${this.player2.hit}, CRT>${this.player2.crt}<p>`;
				this.player2.hp;
			},

			dodge: async function(p, pos, trigger){

				const missAudio = new Audio("msc/Attack Miss 2.wav");

				return new Promise(resolve=>{
					setTimeout(_=>{
						resolve(
							{ p, pos, trigger, missAudio}
							);
					}, trigger);
				});

			},

			hit: async function(p_damaged, p_atks, trigger){

				const hitAudio = new Audio("msc/Attack Hit 1.wav");

				return new Promise(resolve=>{
					setTimeout(_=>{
						resolve(
							{ p_damaged, p_atks, trigger, hitAudio}
							);
					}, trigger);
				});

			},

			battleCalc: function (p_damaged, p_atks){

				const random100 = Math.ceil((Math.random()*100));
				const randomCrit = Math.ceil((Math.random()*100));
				let crit = false;
				let critAnimationTime = 0;

				console.log(random100);

				if (randomCrit <= this["player"+p_atks].crt) /**/
					{	
						this.drawCharsCrit(p_atks);
						critAnimationTime = 700;
						crit = true;
					};

				//chama a animação de atk
				this.normalATK(p_atks, 100, crit);

				// se escapar do campo de hit, esquivar
				if (random100 > mesa["player"+p_damaged].hit) { 

					// ESQUIVA
					// document.getElementById("image1").style.backgroundPosition = `100px 0px`;
					// anima o dodge asyncrono, args = posição do dodge, tempo de ativação
					this.dodge(p_damaged, 100, 500+critAnimationTime).then(res=>{
						document.getElementById("image"+res.p).style.backgroundPosition = `${res.pos}px 0px`;
						res.missAudio.play();
						console.log('dodge ativado', res.p, res.pos)

						setTimeout(_=>{
							document.getElementById("image"+res.p).style.backgroundPosition = `1100px 0px`;
						}, res.trigger);
					});

					console.log("ESQUIVA do player", p_damaged, "result", random100);

				} else {



					let luckMultiplier = 1;
					// se entrar no campo de sorte. aumenta o atk
					if (random100 <= this["player"+p_atks].luck ) luckMultiplier = 2 ;
					if (randomCrit <= this["player"+p_atks].crt) luckMultiplier = 3;

					// mesa["player"+p_damaged].hp -= mesa["player"+p_atks].mt;

					// return null;
					this.hit(p_damaged, p_atks, 500+critAnimationTime ).then(res=>{

						res.hitAudio.play();
						this["player"+p_damaged].hp -= this["player"+p_atks].mt * luckMultiplier;
						this.drawData();
						console.log("hitaddo");
					})
					console.log("DANO do player", p_atks, "result", random100);

				}


				// o moveimage, basicamente seria uma chamada de ataque, pois a funct atk o chama
				// emtão vamos separar duas funções, uma pra substituir o moveimage, e outra pra fazer o movimento critico


			},

			atk: function(p){
				

				if (this.battleLock) return console.log("espere a batalha acabar");

				
				if (p === 1) {
					// damaged / by player 
					this.battleCalc(2, 1);
				}

				if (p === 2) {
					// damaged / by player 
					this.battleCalc(1, 2);
				}

				// this.drawGame(); // atualizava o dano

				// this.moveImage(p);

				// animateScript(p);

				this.battleLock = true;

				setTimeout(_=>{this.battleLock = false}, 3000);

				
			},

			fadeOut: async function(p_atks, trigger){

				let playerImage = document.getElementById("image"+p_atks);

				return Promise(resolve=>{
					setTimeout(_=>{
						// animação de fade out
						playerImage.style.opacity = "0";
						playerImage.style.webkitTransition = "opacity 0.3s ease-in-out";
						playerImage.style.transition = "opacity 0.3s ease-in-out";
					}, trigger)
				})

			},

			normalATK: async function(p_atks, fps, crit){

				
				let     position = 100; //start position for the image slicer
				const   interval = fps; //100 ms of interval for the setInterval()

				let positionMax = 900;
				let positionAdvance = 300;
				let startPosition = 1100;

				if (crit) {
					positionMax = 1600;
					positionAdvance = 700;
					startPosition = 1600;
				}

				tID = setInterval ( () => {

					let playerImage = document.getElementById("image"+p_atks);

					// console.log(position);

					// seta a imagem a cada milisegundo do setInterval
					playerImage.style.backgroundPosition = `-${position}px 0px`; 

					let 	ite = 40;

					// a partir do quadro 400, move a imagem
					if (position > positionAdvance) {

						// seta o index pra sobrepor o inimigo ao atacar
						playerImage.style.zIndex = 1;
						playerImage.style.position = "relative";

						ite+= 3;
						// move a imagem mais adiante para encostar no inimigo
						if (p_atks === 1) {
							playerImage.style.left = (ite+"px");
						} else {
							playerImage.style.right = (ite+"px");
						}
					} // end if position

					// se a posição for menor que 900, move 1 frame
					if (position < positionMax) { 
						position = position + 100;
					}
					// se ultrapassar o limite, termina com estes sets de fades e etc
					else { 	

  						setTimeout(_=>{
  							
  							// animação de fade out
							playerImage.style.opacity = "0";
							playerImage.style.webkitTransition = "opacity 0.3s ease-in-out";
	  						playerImage.style.transition = "opacity 0.3s ease-in-out";

	  						setTimeout(_=>{

	  							// a imagem volta ao index 0
	  							playerImage.style.zIndex = 0;
								playerImage.style.position = "relative";

								// devolve a posição inicial do frame
	  							playerImage.style.backgroundPosition = `${startPosition}px 0px`;

	  							// testa o player, e seta left ou  right pro respectivo player
	  							p_atks = p_atks === 1 ? playerImage.style.left = "40px" : playerImage.style.right = "40px";

	  							// animação de fade in
	  							playerImage.style.opacity = "1";
	  							playerImage.style.animationName = "fadeInOpacity";
	  							playerImage.style.animationIterationCount = 1;
	  							playerImage.style.animationTimingFunction = "ease-in";
	  							playerImage.style.animationDuration = "2s";

	  							this.drawChars();


	  						}, 500);

						}, 100);
	

						clearInterval(tID); // para o loop

					 } // end if posision
				}, interval ); //end of setInterval

			},

			drawButtons: function(){

				let divButtons = document.getElementById("painel-buttons");
				divButtons.innerHTML = "<button onclick='mesa.atk(1)'>Atacar 2</button>";
				divButtons.innerHTML += "<button onclick='mesa.atk(2)'>Atacar 1</button>";

			},

			drawCharsCrit: function(p_atks){

				let img = document.getElementById("image"+p_atks);

				if (p_atks === 1) 
				img.style = "background-color: green; height: 50px; width: 100px; background: url('files/erikaCriti.png') 0px 0px; -webkit-transform: scaleX(-1); transform: scaleX(-1); position: relative; left: 40px;";

				if (p_atks === 2) 
				img.style = "background-color: green; height: 50px; width: 100px; background: url('files/erikaCriti.png') 0px 0px; position: relative; right: 40px;";
			},

			drawChars: function(){


				let img1 = document.getElementById("image1");

				img1.style = "background-color: green; height: 50px; width: 100px; background: url('files/erika.png') 0px 0px; -webkit-transform: scaleX(-1); transform: scaleX(-1); position: relative; left: 40px;"

				let img2 = document.getElementById("image2");

				img2.style = "background-color: green; height: 50px; width: 100px; background: url('files/erika.png') 0px 0px; position: relative; right: 40px;"

				/*height: 41px;
				width: 100px;
				background: 
				url('erika.png') 0px 0px;
				-webkit-transform: scaleX(-1);
	  			transform: scaleX(-1);

	  			position: relative;
	    		left: 40px;*/
			},

			drawGame: function(){
				// console.log(arguments.callee.name, "init");

				if (!this.gameStart) return this.drawSceneLogo();

				this.drawData();
				this.drawChars();
				this.drawButtons();

				// console.log(arguments.callee.name, "end");


			}


		}

	</script>

	<style type="text/css">
		#image1 {
		  /*height: 41px;
		  width: 100px;
			background: 
			url('erika.png') 0px 0px;
			-webkit-transform: scaleX(-1);
  			transform: scaleX(-1);

  			position: relative;
    		left: 40px;*/
		}

		#image2 {
		  /*height: 41px;
		  width: 100px;
			background: 
			url('erika.png') 0px 0px;

			position: relative;
    		right: 40px;*/
		}

		#image1, #image2{
			display: inline-block;
		}

		#demo {
			    text-align: center;
			    text-align: -web-kit-center;
		}
	</style>

</head>
<body>
	<div id="demo">
		<div id="logo"></div>
		
		<div id="corpo" style="zoom: 2.5">
			<div id="painel-data"></div>
			<div id="painel-buttons"></div>
			<div id="status1" >  </div>
			<div id="image1" >  </div>
			<div id="image2" >  </div>
			<div id="status2" >  </div>
		</div>

	</div>
</body>

<script type="text/javascript">

	mesa.drawGame();
	
</script>
</html>