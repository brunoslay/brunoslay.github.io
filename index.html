<!DOCTYPE html>
<html style="background-color: #222120;">
<head>
	<title></title>

	<style type="text/css">

		#back-logo {
			background-image:  linear-gradient(#7a8a8d 41%, #c6cacf);
			border-radius: 8px 0 0;
		}
		
		#corpo {
			display: grid;
			grid-template-columns: auto auto;
			grid-template-rows: 100px auto;
			/*grid-template-areas: "painel-data painel-buttons" "painel-buttons painel-buttons" "footer footer"; */
		}

		#painel-data{
			background-color: #c6cacf;
			grid-area: painel-data;
			grid-column: 1 / 4;
			grid-row: 1;

			border-radius: 0px 0px 0px 8px;

			white-space: pre-wrap;      /* CSS3 */   
			white-space: -moz-pre-wrap; /* Firefox */    
			white-space: -pre-wrap;     /* Opera <7 */   
			white-space: -o-pre-wrap;   /* Opera 7 */    
			word-wrap: break-word;      /* IE */

			overflow-x: hidden;

			padding: 2px;

		}

		button {
			margin: 3px 5px;
		}

		#painel-buttons {
			/*background-color: blue;*/
			grid-area: painel-buttons;
			grid-column: 1 / 4;
			grid-row: 2;


		}

		#players {
			background-color: #7a8a8d;
			grid-area: painel-players;
			grid-column: 2;
			grid-row: 3;
		}

		#status1 {
			background-color: #c6cacf;
			grid-area: status_one;
			grid-column: 1;
			grid-row: 3;
		}

		#status2 {
			background-color: #c6cacf;
			grid-area: status_two;
			grid-column: 3;
			grid-row: 3;
		}




		/*.grid-line{
			border: solid 1px red;
		}

		ul {
			list-style: none;
			display: flex;
			justify-content: center;
		}

		li {
			padding: 10px 10px;
		}

		
		main {
			background-color: green;
			grid-area: main;
		}

		footer{
			background-color: darkgrey;
			grid-area: footer;
		}*/

	</style>

	<script type="text/javascript">
		const mesa = {
			player1: {
				lifes: 3, characters: null,
			},

			player2: {
				lifes: 3, characters: null,
			},
			cpu: {hp: 100, mt: 10, hit: 80, crit: 25, luck: 30, c:"CPU"},

			gameStart: false,
			gameOver: false,
			turn:1,
			time: 1,
			battleLock: false,

			drawSceneLogo: _=>{

				document.getElementById("logo").style.background = 'url("files/Fire_Emblem_logo.png")  center / 725px no-repeat';
				// document.getElementById("logo").style.backgroundSize = '400px';
				// document.getElementById("demo").style.backgroundRepeat = "no-repeat";
				document.getElementById("logo").style.height = "230px";

				// document.getElementById("logo").style.backgroundColor = "#7a8a8d";

				document.getElementById("painel-buttons").innerHTML = "<button onclick='mesa.startgame()'>Iniciar o jogo</button>";	

			},

			startgame: function(){

				this.gameStart = true;
				this.drawGame();
			},

			

			dodge: async function(p, pos, trigger){

				const missAudio = new Audio("msc/Attack Miss 2.wav");

				return new Promise(resolve=>{
					setTimeout(_=>{
						resolve(
							{ p, pos, trigger, missAudio}
							);
					}, trigger);
				});

			},

			audio: async function(conflito){


				let audioFile;

				if (conflito.result === 1) audioFile = "msc/Attack Hit 1.wav";
				if (conflito.result === 2) audioFile = "msc/Attack Hit 3.wav";
				if (conflito.dodge === true) audioFile = "msc/Attack Miss 2.wav";

				const audio = new Audio(audioFile);

				audio.play();
				

			},

			hit: async function(p_damaged, p_atks, trigger){

				const hitAudio = new Audio("msc/Attack Hit 1.wav");

				return new Promise(resolve=>{
					setTimeout(_=>{
						resolve(
							{ p_damaged, p_atks, trigger, hitAudio}
							);
					}, trigger);
				});

			},

			atk: function(p){
				

				if (this.battleLock) return console.log("Espere a batalha acabar. . .");

				if (!this.gameStart) return this.drawData("erika", "<br>O JOGO ENCERROU");

				// 1 = player 1 //  0 = player 2
				// if () return console.log("")

				let conflito_result;
				if (p === 1 && this.time === 1) {
					// damaged / by player 
					conflito_result = this.conflito(2, "erika", p, "erika");
					this.animation(p, "erika", 2, "erika", conflito_result);
					console.log("resultado do conflito:", conflito_result);

					this.battleLock = true;
					setTimeout(_=>{this.battleLock = false}, 3000);
				}

				if (p === 2 && this.time === 0) {
					// damaged / by player 
					conflito_result = this.conflito(1, "erika", p, "erika");
					this.animation(p, "erika", 1, "erika", conflito_result);
					console.log("resultado do conflito:", conflito_result);

					this.battleLock = true;
					setTimeout(_=>{this.battleLock = false}, 3000);
				}

				// this.drawGame(); // atualizava o dano

				// this.moveImage(p);

				// animateScript(p);

				

				

				
			},

			fadeOut: async function(p_atks, trigger){

				let playerImage = document.getElementById("image"+p_atks);

				return Promise(resolve=>{
					setTimeout(_=>{
						// animação de fade out
						playerImage.style.opacity = "0";
						playerImage.style.webkitTransition = "opacity 0.3s ease-in-out";
						playerImage.style.transition = "opacity 0.3s ease-in-out";
					}, trigger)
				})

			},

			conflito: function (p_damaged, char_damaged, p_atks, char_atks){

				/*
					
					testa o hit e retorna resultado

					se dodge, retorna dodge
					senão retorna hit

					se hit, testa critico
					se critico, dobra o dano e retorna "critico"
					senão, dano normal e retorna "normal"


				*/

				if(!this.gameStart) return drawData("erika", "Jogador x perceu. Fim de jogo!");

				
				const hitNumber = Math.ceil((Math.random()*100));
				const critNumber = Math.ceil((Math.random()*100));

				// causa algum tipo de dano
				// normal ou critico?

				let multiplicador = 1;

				if (critNumber <= this["player"+p_atks].characters[char_atks]["crit"+p_atks]) {
					// aumenta os danos
					multiplicador = 2;
				}
				
				// testa a chance de hit do jogador que atacou
				if (hitNumber <= this["player"+p_atks].characters[char_atks]["hit"+p_atks]) {


					////////// PROCESSO DE CALCULOS

					/*this["player"+p_damaged].characters[char_damaged]["hp"+p_damaged] -= 10 * multiplicador;*/

					console.log(p_damaged);

					console.log("player2", this["player"+p_damaged].characters[char_damaged].hp2);
					console.log("player1", this["player"+p_atks].characters[char_atks].hp1);


					// this["player"+p_damaged].characters[char_damaged].hp -= this["player"+p_atks].characters[char_atks].mt;

					// console.log(this["player"+p_damaged].characters[char_damaged].hp, "HPP");



					

					return {dodge: false, result: multiplicador};

					////// aAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA RESULTADO IGUAL NÃO SEI PQ

				}

				// testa a chance de erro do jogador que atacou
				if (hitNumber > this["player"+p_atks].characters[char_atks]["hit"+p_atks]) {

					return {dodge: true, result: multiplicador};
				}



			},

			damage: function(p_damaged, char_damaged, p_atks, char_atks, conflito){

				let playerAtk = this["player"+p_atks].characters[char_atks]["mt"+p_atks];
				let txt_log;

				let hp1 = this["player"+p_atks].characters[char_atks]["hp"+p_atks];
				let hp2 = this["player"+p_damaged].characters[char_damaged]["hp"+p_damaged];

				let dmg = playerAtk * conflito.result;


				if (conflito.result === 1 && conflito.dodge === false) {

					

					this["player"+p_damaged].characters[char_damaged]["hp"+p_damaged] -= dmg;

					this.audio(conflito);
					console.log("dano normal de", dmg);
					txt_log = `<br><strong>Player ${p_atks}</strong> causou dano <strong>normal</strong> de <strong>${dmg}</strong>`;

				}

				if (conflito.result === 2 && conflito.dodge === false) {

					this["player"+p_damaged].characters[char_damaged]["hp"+p_damaged] -= dmg;

					this.audio(conflito);
					console.log("dano critico de", playerAtk * conflito.result);
					txt_log = `<br><strong>Player ${p_atks}</strong> causou dano <strong>CRÍTICO</strong> de <strong>${dmg}</strong>`;

				}

				if (conflito.dodge === true) {

					this["player"+p_damaged].characters[char_damaged]["hp"+p_damaged] -= playerAtk * 0;
					this.audio(conflito);
					console.log("dodge!! dano ", playerAtk * 0);
					txt_log = `<br><strong>Player ${p_damaged} esquivou</strong> do ataque. Nenhum dano foi causado.`;

				}

				// testa se tem vida, se for 0 ou menor seta gamestart pra false
				if (
					this["player"+p_atks].characters[char_atks]["hp"+p_atks] <= 0 
					|| this["player"+p_damaged].characters[char_damaged]["hp"+p_damaged] <= 0
				) {
					this.gameStart = false;
					txt_log+= `<br>FIM DE JOGO. <span style='color: green'>JOGADOR ${p_atks} VENCEU!!</span>`;
				}

				this.drawData("erika", txt_log);
				// this.drawButtons("erika", txt_log);

			},


			animation: async function(p_atks, char_atks, p_damaged, char_damaged, conflito, fps = 110){


				/*
					
					0) testa o conflito
					1) setar a folha baseado no conflito
					2) setar as cordenadas da folha baseado no conflito
					3) setar o som baseado no conflito
					4) setar o resultado da batalha baseado no conlfito


				*/


				let perso = this["player"+p_atks].characters[char_atks];


				let     position = 100; //start position for the image slicer
				const   interval = fps; //100 ms of interval for the setInterval()

				let frameSize 	= 	perso.sheet1.size;
				let frameAdv 	= 	perso.sheet1.adv;
				let frameStand 	= 	perso.sheet1.stand;
				let frameColision =	perso.sheet1.colision;

				let fadeOut 	=	perso.fades.out;
				let fadeIn 		=	perso.fades.in;

				if (conflito.result === 2) {
					frameSize 	= 	perso.sheet2.size;
					frameAdv 	= 	perso.sheet2.adv;
					frameStand 	= 	perso.sheet2.stand;
					frameColision =	perso.sheet2.colision;


					let imgChar = this["player"+p_atks].characters[char_atks].sheet2.img;

					document.getElementById("image"+p_atks).style.background = `url("${imgChar}") 0px 0px`
				}


				// roda os frames de 100 em 100
				tID = setInterval ( () => {

					let playerImage = document.getElementById("image"+p_atks);

					// console.log(position);

					// seta a imagem a cada milisegundo do setInterval
					playerImage.style.backgroundPosition = `-${position}px 0px`; 

					let 	ite = 40;

					// a partir do quadro 400, move a imagem
					if (position > frameAdv) {

						// seta o index pra sobrepor o inimigo ao atacar
						playerImage.style.zIndex = 1;
						playerImage.style.position = "relative";

						ite+= 3;
						// move a imagem mais adiante para encostar no inimigo
						if (p_atks === 1) {
							playerImage.style.left = (ite+"px");
						} else {
							playerImage.style.right = (ite+"px");
						}
					} // end if position


					if (position > frameColision && position < frameColision + 200) {


						// causa o dano e chama o som
						this.damage(p_damaged, char_damaged, p_atks, char_atks, conflito);

						console.log("hit box done");
					}

					// se a posição for menor que 900, move 1 frame
					if (position < frameSize) { 
						position = position + 100;
					}
					// se ultrapassar o limite, termina com estes sets de fades e etc
					else { 	

  						setTimeout(_=>{
  							
  							// animação de fade out
							playerImage.style.opacity = "0";
							playerImage.style.webkitTransition = "opacity 0.3s ease-in-out";
	  						playerImage.style.transition = "opacity 0.3s ease-in-out";

						}, fadeOut);

						setTimeout(_=>{

  							// a imagem volta ao index 0
  							playerImage.style.zIndex = 0;
							playerImage.style.position = "relative";

							// devolve a posição inicial do frame
  							playerImage.style.backgroundPosition = `${frameStand}px 0px`;

  							// testa o player, e seta left ou  right pro respectivo player
  							p_atks = p_atks === 1 ? playerImage.style.left = "40px" : playerImage.style.right = "40px";

  							// animação de fade in
  							playerImage.style.opacity = "1";
  							playerImage.style.animationName = "fadeInOpacity";
  							playerImage.style.animationIterationCount = 1;
  							playerImage.style.animationTimingFunction = "ease-in";
  							playerImage.style.animationDuration = "2s";


  							this.turn++;

  							this.time = this.turn%2;

  							console.log("TURNO:", this.turn, "Vez de", this.time);

  							if (this.time === 0) {
  								setTimeout(_=>{

  									this.atk(2);

  								}, 2000);
  							}



  							this.drawChars();


  						}, fadeIn);
	

						clearInterval(tID); // para o loop

					 } // end if posision
				}, interval ); //end of setInterval

			},


			drawSideDatas: function(char_name){

				console.log("draaaaaaaaaaaaaa");

				let displayHP = document.getElementById("display-hp1");
				let displayMT = document.getElementById("display-mt1");
				let displayHIT = document.getElementById("display-hit1");
				let displayCRIT = document.getElementById("display-crit1");


				displayHP.innerHTML = `${this.player1.characters[char_name].hp1}`;
				displayMT.innerHTML = `${this.player1.characters[char_name].mt1}`;
				displayHIT.innerHTML = `${this.player1.characters[char_name].hit1}`;
				displayCRIT.innerHTML = `${this.player1.characters[char_name].crit1}`;

				let displayHP2 = document.getElementById("display-hp2");
				let displayMT2 = document.getElementById("display-mt2");
				let displayHIT2 = document.getElementById("display-hit2");
				let displayCRIT2 = document.getElementById("display-crit2");


				displayHP2.innerHTML = `${this.player2.characters[char_name].hp2}`;
				displayMT2.innerHTML = `${this.player2.characters[char_name].mt2}`;
				displayHIT2.innerHTML = `${this.player2.characters[char_name].hit2}`;
				displayCRIT2.innerHTML = `${this.player2.characters[char_name].crit2}`;



				/*,MT>${this.player1.characters[char_name].mt1}, HIT>${this.player1.characters[char_name].hit1}, CRT>${this.player1.characters[char_name].crit1}<p>`;

				divPaineldata.innerHTML += `PLAYER 2: ${char_name} HP>${this.player2.characters[char_name].hp2},MT>${this.player2.characters[char_name].mt2}, HIT>${this.player2.characters[char_name].hit2}, CRT>${this.player2.characters[char_name].crit2}<p>`;*/
			},

			drawData: function(char_name, txt_log){

				// console.log("draaaaaaaaaaaaaa");

				this.drawSideDatas(char_name);

				let divPaineldata = document.getElementById("painel-data");
				let painel = document.getElementById("painel-data");

				// return divPaineldata.innerHTML += char_name;

				 divPaineldata.innerHTML += txt_log;

				return painel.scrollTop = painel.scrollHeight;

				divPaineldata.innerHTML = `PLAYER 1: ${char_name} HP>${this.player1.characters[char_name].hp1},MT>${this.player1.characters[char_name].mt1}, HIT>${this.player1.characters[char_name].hit1}, CRT>${this.player1.characters[char_name].crit1}<p>`;

				divPaineldata.innerHTML += `PLAYER 2: ${char_name} HP>${this.player2.characters[char_name].hp2},MT>${this.player2.characters[char_name].mt2}, HIT>${this.player2.characters[char_name].hit2}, CRT>${this.player2.characters[char_name].crit2}<p>`;
			},

			drawButtons: function(){

				let divButtons = document.getElementById("painel-buttons");
				divButtons.innerHTML = "<button onclick='mesa.atk(1)'>Atacar 2</button>";
				divButtons.innerHTML += "<button onclick='mesa.atk(2)'>Atacar 1</button>";

			},

			drawCharsCrit: function(p_atks){

				let img = document.getElementById("image"+p_atks);

				if (p_atks === 1) 
				img.style = "background-color: green; height: 50px; width: 100px; background: url('files/erikaCriti.png') 0px 0px; -webkit-transform: scaleX(-1); transform: scaleX(-1); position: relative; left: 40px;";

				if (p_atks === 2) 
				img.style = "background-color: green; height: 50px; width: 100px; background: url('files/erikaCriti.png') 0px 0px; position: relative; right: 40px;";
			},

			drawChars: function(){


				let img1 = document.getElementById("image1");

				img1.style = "background-color: green; height: 50px; width: 100px; background: url('files/erika.png') 0px 0px; -webkit-transform: scaleX(-1); transform: scaleX(-1); position: relative; left: 40px;"

				let img2 = document.getElementById("image2");

				img2.style = "background-color: green; height: 50px; width: 100px; background: url('files/erika.png') 0px 0px; position: relative; right: 40px;"

				/*height: 41px;
				width: 100px;
				background: 
				url('erika.png') 0px 0px;
				-webkit-transform: scaleX(-1);
	  			transform: scaleX(-1);

	  			position: relative;
	    		left: 40px;*/
			},

			drawGame: function(){
				// console.log(arguments.callee.name, "init");

				if (!this.gameStart) return this.drawSceneLogo();

				console.log(chars.erika);

				this.player1.characters = chars;
				this.player2.characters = chars;

				this.drawData("erika", "Inicio de jogo");
				this.drawChars();
				this.drawButtons();

				// console.log(arguments.callee.name, "end");


			}


		}


		const chars = {
			erika: {
				sheet1: {
					img: "files/erika.png",
					stand: 1100,
					adv: 300,
					size: 900, // deixar o size sempre 100 a menos do total
					colision: 400
				},

				sheet2: {
					img: "files/erikaCriti.png",
					stand: 1600,
					adv: 700,
					size: 1500, // deixar o size sempre 100 a menos do total
					colision: 1000
				},

				fades: {
					in: 500,
					out: 100
				},

				hp1: 100, mt1: 35, hit1: 80, crit1: 25,
				hp2: 100, mt2: 35, hit2: 80, crit2: 25
			}
		}

	</script>

	<style type="text/css">
		#image1 {
		  /*height: 41px;
		  width: 100px;
			background: 
			url('erika.png') 0px 0px;
			-webkit-transform: scaleX(-1);
  			transform: scaleX(-1);

  			position: relative;
    		left: 40px;*/
		}

		#image2 {
		  /*height: 41px;
		  width: 100px;
			background: 
			url('erika.png') 0px 0px;

			position: relative;
    		right: 40px;*/
		}

		#image1, #image2{
			display: inline-block;
		}

		#demo {
			    text-align: center;
			    text-align: -web-kit-center;
		}
	</style>

</head>
<body>
	<div id="demo">
		<div id="back-logo">
			<div id="logo"></div>
		</div>
		
		<div id="corpo" style="zoom: 2.5">

			<div id="painel-data" style="overflow-y:scroll;"></div>

			<div id="painel-buttons"></div>

			<div id="status1" > 

				HP:<span id="display-hp1">hp</span><br>
				MT:<span id="display-mt1">mt</span><br>
				HIT:<span id="display-hit1">hp</span><br>
				CRIT:<span id="display-crit1">hp</span><br>

			</div>

			<div id="players">
				<div id="image1" >  </div>
				<div id="image2" >  </div>
			</div>

			<div id="status2" > 

				HP:<span id="display-hp2">hp</span><br>
				MT:<span id="display-mt2">mt</span><br>
				HIT:<span id="display-hit2">hp</span><br>
				CRIT:<span id="display-crit2">hp</span><br>

			</div>
		</div>

	</div>
</body>

<script type="text/javascript">

	mesa.drawGame();
	
</script>
</html>